---
title: "Application Exercise 12 - Data wrangling with dplyr"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
execute:
  echo: true
  message: false
  warning: false
---

# Note!

## Task descriptions and starter code

You will notice that the descriptions of tasks are getting shorter with less detail provided. This is the case for all functions you have previously practised either in your homework or in live coding exercises in class. Tasks that are **fill in the blanks** exercises will also decrease.

## Final exam

Pay close attention to how the tasks are phrased, as this closer to how they will be phrased in in the final exam. For most tasks in the final exam, exercises won't have starter code or be **fill in the blanks** exercises.

Studying for the exam means practising writing code now. You currently have three options to do that:

-   Programming assignments exercises like this
-   The R4DS book and your notebook repository
-   Your research project report

You must write as much code independently as you can. While we realise that homework assignments can be copied from other classmates, it is to your disadvantage if you do so. You will not have an opportunity to practice writing code independently, which you will need to be able to do for the final exam.

# Task 0: Load R packages

1.  Load the `dplyr`, `readr`, and `ggplot2` R Packages.

```{r}
library(dplyr)
library(readr)
library(ggplot2)
```

# Task 1: Data import

1.  Use the `read_csv()` function to import the 'country_level_data_0.csv' file by assigning it to an object name `global_waste_data`

```{r}
global_waste_data <- read_csv("data/raw_data/country_level_data_0.csv")
```

# Task 2: Data tidying

## dplyr::select()

### Part 1

**Fill in the blanks**

1.  Start with the `global_waste_data` object and use the `select()` function to create a subset that only keeps the following variables:

-   `iso3c`
-   `total_msw_total_msw_generated_tons_year`
-   all variables that end with "percent"

2.  Run the code contained in the code-chunk and fix any errors

3.  Next to the code-chunk option `#| eval:` change the value from `false` to `true`

4.  Render and fix any errors

```{r}
#| eval: true

global_waste_data %>% 
  select(iso3c, ends_with("percent"))
```

### Part 2

**Write the code yourself**

1.  Start with the `global_waste_data` object and use the `select()` function to create a subset that only keeps the following variables:

-   `country_name`
-   `income_id`
-   `total_msw_total_msw_generated_tons_year`
-   `population_population_number_of_people`
-   all variables starting with "composition"

2.  Store the subset as a new object in your environment with the name `composition`

3.  Render and fix any errors

```{r}

composition <- global_waste_data %>% 
  select(country_name, 
         income_id, 
         population_population_number_of_people, 
         total_msw_total_msw_generated_tons_year,
         starts_with("composition"))

```

### Part 3

**Write the code yourself**

1.  Start with the `composition` object and use the `rename()` function to rename all columns that start with "composition". Shorten the names to keep the waste category only (e.g. rename `composition_food_organic_waste_percent` to `food_organic_waste`)

2.  Rename `total_msw_total_msw_generated_tons_year` to `msw_tons_year`.

3.  Rename `population_population_number_of_people` to `population`

4.  Store the subset as a new object in your environment with the name `composition_tidy`

5.  Render and fix any errors

6.  Commit your changes

```{r}

composition_tidy <- composition %>% 
  rename(food_organic_waste = composition_food_organic_waste_percent,
         glass = composition_glass_percent,
         metal = composition_metal_percent,
         other = composition_other_percent,
         paper_cardboard = composition_paper_cardboard_percent,
         plastic = composition_plastic_percent,
         rubber_leather = composition_rubber_leather_percent,
         wood = composition_wood_percent,
         yard_garden_green_waste = composition_yard_garden_green_waste_percent,
         msw_tons_year = total_msw_total_msw_generated_tons_year,
         population = population_population_number_of_people) 

```

# Task 3: Data transformation

## dplyr::filter()

### Part 1

**Fill in the blanks**

1.  Use the `filter()` function in combination with `is.na()` to create a subset from `composition_tidy` containing observations for countries with missing data for the variable which has percentages on food and organic waste.

2.  Next to the code-chunk option `#| eval:` change the value from `false` to `true`

```{r}
#| eval: true

composition_tidy %>%  
  filter(is.na(food_organic_waste))

```

### Part 2

**Write the code yourself**

1.  Use the `filter()` to create a subset from `composition_tidy` containing observations for countries classified as high-income countries (HIC).

```{r}

composition_tidy %>% 
  filter(income_id == "HIC")

```

### Part 3

**Write the code yourself**

1.  Use the `filter()` to create a subset from `composition_tidy` containing observations for countries that are not classified as low-income countries (LIC).

```{r}

composition_tidy %>% 
  filter(income_id != "LIC") 

```

### Part 4

**Write the code yourself**

1.  Create a subset from `composition_tidy` containing observations for countries classified as high-income countries (HIC) and with food and organic waste composition greater than 50%.

```{r}

composition_tidy %>% 
  filter(income_id == "HIC",
         food_organic_waste > 50)

```

### Part 5

**Write the code yourself**

1.  Create a subset from `composition_tidy` containing observations for countries classified as high-income countries or low-income countries. IC) or high and with food and organic waste composition greater than 50%.

```{r}

composition_tidy %>% 
  filter(income_id == "HIC" | income_id == "LIC",
         other > 40)
```

### Part 6

**Write the code yourself**

1.  Create a subset from `composition_tidy` containing observations for countries named Switzerland, Guam, Costa Rica, Angola, or Kiribati.

2.  Render and fix any errors

3.  Commit your changes

```{r}

composition_tidy %>% 
  filter(country_name %in% c("Switzerland",
                             "Guam",
                             "Costa Rica",
                             "Angola",
                             "Kiribati"))

```

## dplyr::mutate() & dplyr::relocate()

**Write the code yourself**

1.  Use the `mutate()` function to add a new column to `composition_tidy` that is the municipal solid waste generation per capita in kg/year. Name the column `msw_capita_kg_year`.

2.  Use the pipe operator to add another line of code which uses the `relocate()` function to move the `msw_capita_kg_year` after the column `msw_tons_year` column.

3.  Store the result as a new object in your environment with the name `composition_tidy_capita`

4.  Render and fix any errors

5.  Commit your changes

```{r}

composition_tidy_capita <-  composition_tidy %>% 
  mutate(msw_capita_kg_year = msw_tons_year / population * 1000) %>% 
  relocate(msw_capita_kg_year, .after = msw_tons_year)

```

## dplyr::mutate() & dplyr::case_when()

**Fill in the blanks**

1.  Use the `mutate()` function to add a new column names `income_cat` to `composition_tidy_capita` that is a variable which contains the unabbreviated categories for the `income_id` variable.

2.  Use the `case_when()` function to convert the abbreviated values in `income_id` to:

-   "high income" if `income_id` is "HIC"
-   "upper-middle income" if `income_id` is "UMC"
-   "lower-middle income" if `income_id` is "LMC"
-   "low income" if `income_id` is "UMC"

**Note:** Pay close attention to spaces and hyphens.

3.  Use the pipe operator to add another line of code which uses the `mutate()` function to convert the `income_cat` variable from a variable of type character to a variable of type factor. For the factor levels, use the provided `levels_income_id` object.

4.  Use the pipe operator to add another line of code which uses the `relocate()` function to move the `income_cat` after the `income_id` column.

5.  Store the result as a new object in your environment with the name `composition_tidy_capita_income_cat`

6.  Render and fix any errors

7.  Commit your changes

```{r}
#| eval: true 

# object that creates a vector with a defined order

levels_income_id <- c("high income", 
                      "upper-middle income",
                      "lower-middle income",
                      "low income")


composition_tidy_capita_income_cat <- composition_tidy_capita %>% 
  mutate(income_cat = case_when(
    income_id == "HIC" ~ "high income",
    income_id == "UMC" ~ "upper-middle income",
    income_id == "LMC" ~ "lower-middle income",
    income_id == "LIC" ~ "low income"
  )) %>% 
  mutate(income_cat = factor(income_cat, levels = levels_income_id)) %>%
  relocate(income_cat, .after = income_id)


```

## dplyr::group_by() & dplyr::summarise()

### Part 1

**Fill in the blanks**

```{r}
#| eval: true

composition_tidy_capita_income_cat %>% 
  group_by(income_id) %>% 
  summarise(count = n())

```

**Write the code yourself**

```{r}

composition_tidy_capita_income_cat %>% 
  group_by(income_cat) %>% 
  summarise(count = n())

```

**Fill in the blanks**

```{r}

composition_tidy_capita_income_cat %>% 
  tidyr::drop_na(msw_capita_kg_year) %>% 
  group_by(income_cat) %>% 
  summarise(
    count = n(),
    mean_msw_total = mean(msw_capita_kg_year)
  )

```

**Write the code yourself**

```{r}

table_msw_generation <- composition_tidy_capita_income_cat %>% 
  tidyr::drop_na(msw_capita_kg_year) %>% 
  group_by(income_cat) %>% 
  summarise(
    count = n(),
    mean = mean(msw_capita_kg_year),
    median = median(msw_capita_kg_year),
    sd = sd(msw_capita_kg_year)
  )

```

**Write the code yourself**

```{r}

table_composition <- composition_tidy_capita_income_cat %>% 
  tidyr::drop_na(msw_capita_kg_year, 
                 food_organic_waste, 
                 plastic,
                 paper_cardboard) %>% 
  group_by(income_cat) %>% 
  summarise(
    count = n(),
    mean_msw_total = mean(msw_capita_kg_year),
    mean_organic = mean(food_organic_waste),
    mean_plastic = mean(plastic),
    mean_paper_cardboard = mean(paper_cardboard)
  )

```

# Task 4: Data visualisations

Below, you will see three types of already prepared plots. There is nothing to write her for you, but the plots provide you with some additional code exmaples for different types of plots.

## Histograms

```{r}
ggplot(data = composition_tidy_capita_income_cat,
       mapping = aes(x = food_organic_waste, fill = income_cat)) +
  geom_histogram()
```

```{r}
ggplot(data = composition_tidy_capita_income_cat,
       mapping = aes(x = plastic, fill = income_cat)) +
  geom_histogram()
```

```{r}
ggplot(data = composition_tidy_capita_income_cat, 
       mapping = aes(x = paper_cardboard)) +
  geom_histogram() +
  facet_wrap(~income_cat)
```

```{r}
ggplot(data = composition_tidy_capita_income_cat,
       mapping = aes(x = other)) +
  geom_histogram() +
  facet_wrap(~income_cat)
```

## Scatterplots

```{r}

ggplot(data = composition_tidy_capita_income_cat,
       mapping = aes(x = msw_capita_kg_year, 
                     y = food_organic_waste,
                     color = income_cat)) +
  geom_point()

```

## Boxplots

```{r}

ggplot(data = composition_tidy_capita_income_cat,
       mapping = aes(income_cat,
                     y = msw_capita_kg_year,
                     color = income_cat)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 2/4)


```

# Task 5: Tables

The [`gt` R Package](https://gt.rstudio.com/index.html) is an extremely powerful package to style tables. Learning the details of how it works is beyond scope of this course, but below is an example for the `table_composition` table that we created when we summarised our data.

1.  Read the code and describe in your own words what each function does

-   `gt()`:
-   `tab_header()`:
-   `fmt_number()`:
-   `starts_with()`:
-   `cols_labels()`:

```{r}

library(gt)

table_composition %>% 
  gt() %>%
  tab_header(
    title = "Municipal Solid Waste by Income",
    subtitle = "Average generation and composition for three waste categories") %>% 
  fmt_number(
    columns = starts_with("mean"), 
    decimals = 1
  ) %>% 
  cols_label(
    income_cat = "Income category",
    count = "number of countries (n)",
    mean_msw_total = "MSW generation per capita (kg/year)",
    mean_organic = "food & organic (%)",
    mean_plastic = "plastic (%)",
    mean_paper_cardboard = "paper & cardboard (%)"
  ) 
  
```

Below is another table for the report that uses the `knitr` R Package to style the table. Columns first need to be renamed with the `rename()` function, and because the column names have spaces in them, we need to add the single backtick around the column/variable name. The result is also satisying and often all you need to prepare a sound looking table for your report. A great extension to `knitr` is the [`kableExtra` R Package](https://haozhu233.github.io/kableExtra/).

1.  Read the code and describe in your own words what each function does

-   \`rename()\`\`:
-   `knitr::kable()`:

```{r}

table_msw_generation %>% 
  rename(`income category` = income_cat) %>% 
  rename(`number of countries (n)` = count) %>% 
  knitr::kable(digits = 1)

```

# Task 6: Complete assignment

Open an issue on the repo for this exercise to let us know you completed it. Use the @larnsce mention.
